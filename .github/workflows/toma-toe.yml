name: Toma Toe Workflow
on: [push]

jobs:
  publish-bicep:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Compile infrastructure
        uses: Azure/cli@1.0.4
        with:
          azcliversion: 2.23.0
          inlineScript: az bicep build --file ./deployment/main.bicep
      - name: Compile infrastructure
        uses: Azure/cli@1.0.4
        with:
          azcliversion: 2.23.0
          inlineScript: az bicep build --file ./deployment/trafficmgr.bicep
      - name: Publish Artifact
        uses: actions/upload-artifact@v2
        with:
          name: bicep-templates
          path: deployment/*.json

  infrastructure-incremental-test:
    needs: publish-bicep
    runs-on: ubuntu-latest
    uses: nikneem/github-actions-start/.github/workflows/deployment.yml@f3819cb6681bb7b162241b843e26b913b8c9a64b
    with:
      environment: test
    secrets:
      azure-login: ${{ secrets.AZURE_TEST }}

  infrastructure-incremental-prod:
    needs: infrastructure-incremental-test
    runs-on: ubuntu-latest
    uses: nikneem/github-actions-start/.github/workflows/deployment.yml@f3819cb6681bb7b162241b843e26b913b8c9a64b
    with:
      environment: prod
    secrets:
      azure-login: ${{ secrets.AZURE_PROD }}
